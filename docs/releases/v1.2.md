# Release v1.2 — Modal Forms, Detail Pages, Attachments & Bug Fixes

**Date:** 2026-02-27
**Commit:** `16fd860`
**Base:** `f73ca20`

## Summary

v1.2 completes the interactive layer of the UI. All major data-entry flows (add expense, log mileage trip, record payment) are now modal forms instead of inline panels. Detail pages for Quotations and Credit Notes are introduced. A polymorphic `AttachmentsPanel` component brings file upload/download to every record type. Twelve bugs covering API field mismatches, route mounting errors, and frontend data-reading issues are fixed. Spec corrections discovered during development are documented in `development-plan.md`.

---

## New Files

| File | Description |
|---|---|
| `apps/api/server.js` | New API entry point — loads dotenv before dynamic `import('./app.js')` to solve ESM hoisting env-var problem |
| `apps/web/src/components/AddExpenseModal.jsx` | Expense form as `ComposedModal`; files staged client-side and uploaded sequentially after expense creation |
| `apps/web/src/components/AttachmentsPanel.jsx` | Reusable attachment panel; accepts `subjectType` + `subjectId` props; supports upload, download, delete |
| `apps/web/src/components/OCRAssistantModal.jsx` | Global AI receipt scanner modal triggered from header Bot icon; extracted data pre-fills `AddExpenseModal` |
| `apps/web/src/components/PaymentModal.jsx` | Reusable payment recording modal; used from Invoice list and Invoice detail |
| `apps/web/src/components/CustomerQuickCreateModal.jsx` | Lightweight inline customer-create modal inside `InvoiceForm` and `QuotationForm` |
| `apps/web/src/pages/Quotations/QuotationDetail.jsx` | Quotation detail page at `/quotations/:id`; actions: send, accept, reject, convert to invoice; AttachmentsPanel |
| `apps/web/src/pages/CreditNotes/CreditNoteDetail.jsx` | Credit note detail at `/credit-notes/:id`; actions: send, submit e-invoice, void; AttachmentsPanel |
| `apps/web/src/pages/Customers/index.jsx` | Full customer CRUD page at `/customers` with DataTable, search, create/edit modal |

---

## Changed Files

| File | What changed |
|---|---|
| `apps/api/app.js` | Payments router mounted at correct path `/api/v1/invoices/:invoiceId/payments` |
| `apps/api/package.json` | `start` and `dev` scripts changed from `node app.js` / `node --watch app.js` to use `server.js` |
| `apps/api/routes/cashFlow.js` | Pre-fills all months in `from`–`to` range (zero-filled); field names changed from `inflow`/`outflow` to `income`/`expenses`; totals shape corrected to `{ totalIncome, totalExpenses, netCashFlow, avgMonthlyNet }` |
| `apps/api/routes/creditNotes.js` | `issue_date` defaults to today; customer fetched via nested `Invoice → Customer` include (no direct `customer_id` on model) |
| `apps/api/routes/documents.js` | `subject_type` defaults to `'general'`; `subject_id` optional, defaults to `0` |
| `apps/api/routes/mileage.js` | All handlers corrected to use actual model fields: `log_date` (was `trip_date`), `km` (was `distance_km`), `deductible_amount` (was `deduction_amount`) |
| `apps/api/routes/quotations.js` | Default list sort changed to `createdAt DESC` |
| `apps/api/controllers/customersController.js` | Default sort `createdAt DESC` |
| `apps/api/controllers/expensesController.js` | Default sort `createdAt DESC` |
| `apps/api/controllers/invoicesController.js` | Default sort `createdAt DESC` |
| `apps/web/src/App.jsx` | Routes added: `/quotations/:id` → `QuotationDetail`, `/credit-notes/:id` → `CreditNoteDetail` |
| `apps/web/src/components/AppShell.jsx` | `HeaderGlobalBar` with Bot icon (OCR) and Logout; manages `OCRAssistantModal` + `AddExpenseModal` state globally |
| `apps/web/src/pages/CashFlow/index.jsx` | API URL corrected to `/cash-flow/actual?from=&to=`; data reads `income`/`expenses` |
| `apps/web/src/pages/CreditNotes/index.jsx` | Row click navigates to detail page |
| `apps/web/src/pages/Documents/index.jsx` | Upload URL fixed to `POST /documents`; `filenameStatus="edit"` on `FileUploader` |
| `apps/web/src/pages/Expenses/index.jsx` | Row click / "View" overflow opens view modal with `AttachmentsPanel`; "Add Expense" opens `AddExpenseModal` |
| `apps/web/src/pages/Invoices/InvoiceDetail.jsx` | Uses shared `PaymentModal`; `AttachmentsPanel` added at bottom |
| `apps/web/src/pages/Invoices/InvoiceForm.jsx` | `CustomerQuickCreateModal` integrated |
| `apps/web/src/pages/Invoices/index.jsx` | "Mark as Paid" opens `PaymentModal`; row lookup via `invoices.find()` (not `row._raw`) |
| `apps/web/src/pages/Mileage/index.jsx` | "Log Trip" is now a modal; row click / "View" opens trip detail modal; all field names corrected to match model |
| `apps/web/src/pages/Quotations/QuotationForm.jsx` | `CustomerQuickCreateModal` integrated |
| `apps/web/src/pages/Quotations/index.jsx` | Row click navigates to detail page |
| `docs/development-plan.md` | Added "Specification Corrections" and "Release Log v1.2" sections |

---

## Bug Fixes

| Area | Symptom | Fix |
|---|---|---|
| Payments | `POST /invoices/:id/payments` → 404 | Fixed route mount path; added `/:invoiceId/payments` segment with `mergeParams: true` |
| ENV vars | Services read empty strings on startup | Created `server.js`; dotenv runs before any module import |
| MileageLog | `POST /mileage` → `log_date cannot be null` | Route corrected to use model field names: `log_date`, `km` |
| MileageLog | `POST /mileage` → `km cannot be null` | Same fix as above |
| CreditNote | `POST /credit-notes` → `issue_date cannot be null` | Backend defaults `issue_date` to `new Date()` when absent |
| CreditNote | `GET /credit-notes` → `Association 'customer' does not exist` | Customer accessed via `Invoice → Customer` nested include |
| Expense | `POST /expenses` → `vendor_name cannot be null` | Frontend field names corrected: `vendor_name`, `expense_date`, `category_id` |
| Expense categories | Dropdown empty on Add Expense form | `GET /expense-categories` returns plain array; was reading `res.data.categories` |
| Cash flow | `GET /cash-flow` → 404 | URL corrected to `/cash-flow/actual?from=YYYY-MM-DD&to=YYYY-MM-DD` |
| Mileage list | `entries.reduce is not a function` | API returns `{ logs, total }`; was reading `.data.data` falling back to object |
| Documents upload | `POST /documents/upload` → 404 | URL corrected to `POST /documents` |
| Documents upload | `subject_id cannot be null` | Standalone uploads use `subject_id = 0`, `subject_type = 'general'` |
| FileUploader | Spinner never disappears after file selection | Added `filenameStatus="edit"` to Carbon `FileUploader` |
| DataTable lookup | `row._raw` undefined | Carbon strips non-header keys; fixed to `state.find(r => String(r.id) === row.id)` |

---

## Spec Changes

> These correct the original design documents. See `docs/development-plan.md → Specification Corrections` for full details.

| Model / Route | Was documented as | Actual |
|---|---|---|
| `MileageLog` date field | `trip_date` | `log_date` |
| `MileageLog` distance field | `distance_km` | `km` |
| `MileageLog` deduction field | `deduction_amount` (client-sent) | `deductible_amount` (server-computed) |
| `MileageLog` default rate | RM 0.25/km | RM 0.60/km (`MILEAGE_RATE_PER_KM` env, default `0.60`) |
| `Document.subject_id` | Required, linked to record | Optional; standalone = `0`, `subject_type = 'general'` |
| Cash flow response fields | `inflow` / `outflow` | `income` / `expenses` |
| Cash flow months | Only months with data returned | All months in range returned, zero-filled |
| Cash flow totals | `{ inflow, outflow, net }` | `{ totalIncome, totalExpenses, netCashFlow, avgMonthlyNet }` |
| `CreditNote` customer | Direct `customer_id` association | Via `invoice.customer` — no direct FK |
| API entry point | `node app.js` / `node --watch app.js` | `node server.js` / `node --watch server.js` |
| Payments route | Mounted at `/api/v1/invoices` | Mounted at `/api/v1/invoices/:invoiceId/payments` |

---

## Upgrade Notes

- **`node server.js`** — update any process manager configs (PM2, Docker CMD) from `app.js` to `server.js`
- **No new migrations** — all changes are route/frontend fixes; existing DB schema is unchanged
- **No new env vars** — `MILEAGE_RATE_PER_KM` is optional (defaults to `0.60`)
